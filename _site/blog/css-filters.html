<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>CSS Filters</title> <meta name="description" content="Last year i decided i was going to write a little application that allowed people to change certain properties pertaining to my Twitter profile picture. With..." /> <meta property="og:image" content="http://localhost:4000/assets/facebook.png"/> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/blog/css-filters"> <link rel="alternate" type="application/atom+xml" title="Taylor Gibb" href="http://localhost:4000/feed.xml" /> <link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"> <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> </head> <body> <div class="logo-container"> <div class="logo-wrapper"> <img src="/assets/avatar.png" class="logo-avatar"> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">CSS Filters</h1> <time class="code">April 3, 2019</time> </div> <div class="divider"></div> <p>Last year i decided i was going to write a little application that allowed people to change certain properties pertaining to my Twitter profile picture. With the introduction of CSS Filters, and in particular the <code class="highlighter-rouge">hue-rotate</code> function, i thought this was going to be a fairly trivial task. My plan was to use a combination of the <code class="highlighter-rouge">hue-rotate</code> and <code class="highlighter-rouge">rotate</code> CSS capabilities to manipulate an avatar on a webpage, and then submit the data to an Azure function that would in turn manipulate a raw copy of the image before publishing it to Twitter. The problem i quickly ran into is that the <code class="highlighter-rouge">hue-rotate</code> CSS Filter uses linear matrix approximation in the RGB colour space to perform the hue rotation and doesnt actually convert the values into HSV or HSL. This effectively meant that when i applied the same filter values using a server side image manipulation library i got completely different results, which my friends were quick to point out.</p> <p>You can see how bad it really gets in this <a href="https://stackoverflow.com/questions/19187905/why-doesnt-hue-rotation-by-180deg-and-180deg-yield-the-original-color">StackOverflow question</a> where a user kindly does a manual comparison and visual demonstration of the differences.</p> <h4 id="client-side">Client Side</h4> <p>On the client side i have two sliders, rotation is pretty straight forward so i am not going to get into that. What i want to show you is the approach i ended up using to adjust the hue of the image. The first things i needed to do was to include the <a href="https://github.com/jseidelin/pixastic">Pixastic</a> library. Once that was done i dropped the image and canvas onto a page.</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">"output-canvas"</span><span class="nt">&gt;&lt;/canvas&gt;</span>
<span class="nt">&lt;img</span> <span class="na">style=</span><span class="s">"display: none"</span> <span class="na">id=</span><span class="s">"avatar"</span> <span class="na">src=</span><span class="s">"/assets/avatar.png"</span><span class="nt">&gt;</span>
</code></pre></div></div> <p>I also needed a way to adjust the value of the hue. Hue is typically expressed on a color wheel with values from <code class="highlighter-rouge">0</code> to <code class="highlighter-rouge">360</code> degrees.</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"toggle"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label&gt;</span>Hue<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"slider"</span> <span class="na">id=</span><span class="s">"hue"</span> <span class="na">type=</span><span class="s">"range"</span> <span class="na">min=</span><span class="s">"0"</span> <span class="na">max=</span><span class="s">"360"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div> <p>From there i attached an event handler that converted the values and scaled them to a value between <code class="highlighter-rouge">-1</code> and <code class="highlighter-rouge">1</code> which Pixastic required.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="s1">'#hue'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">options</span><span class="p">[</span><span class="s2">"hue"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span><span class="p">;</span>
    <span class="nx">update</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div> <p>Most of the magic takes place in the update method you see above. This is executed every time you change the value of a slider and does the following:</p> <ul> <li>Hides the image and the canvas</li> <li>Sets the dimensions of the canvas</li> <li>Draws the original image to the canvas</li> <li>Processes the Pixastic effects</li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">update</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"avatar"</span><span class="p">),</span>
        <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"output-canvas"</span><span class="p">),</span>
        <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span>

    <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">"none"</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="nx">Px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pixastic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="nx">Px</span><span class="p">[</span><span class="s2">"hsl"</span><span class="p">](</span><span class="nx">options</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">"block"</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div> <p>Once you are done and you click upload, the values from the sliders are submitted to an Azure function.</p> <h4 id="server-side">Server Side</h4> <p>I decided to give it another go this afternoon with great results. Ultimately i ended up using <a href="https://github.com/oliver-moran/jimp">Jimp</a> on the server and <a href="https://github.com/jseidelin/pixastic">Pixastic</a> on the client side. The source code for the web page can be found over <a href="https://github.com/taylorgibb/taylorgibb.github.io/blob/master/lab/avatar.md">here</a>, and the code for the function lives <a href="https://github.com/taylorgibb/taylorgibb.github.io/blob/master/functions/avatar/index.js">here</a>. If you feel the need, you can even head over to <a href="https://www.taylorgibb.com/lab/avatar.html">my lab and change the picture yourself</a>.</p> </article> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = "https://www.taylorgibb.com/blog/css-filters", this.page.identifier = "/blog/css-filters"; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://taylorgibb.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <script id="dsq-count-scr" src="//taylorgibb.disqus.com/count.js" async></script> <div class="footer"> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a>, source code on <a href="https://github.com/taylorgibb/taylorgibb.github.io">Github</a></small></span> </div> </body> </html>
